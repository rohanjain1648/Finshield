<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometrics Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>📊 Behavioral Biometrics Dashboard</h1>
            <p class="subtitle">Real-time analytics and monitoring</p>
        </header>

        <!-- Navigation Tabs -->
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="showTab('overview')">Overview</button>
            <button class="tab-btn" onclick="showTab('analytics')">User Analytics</button>
            <button class="tab-btn" onclick="showTab('security')">Security Monitor</button>
            <button class="tab-btn" onclick="showTab('exports')">Data Export</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="total-users">--</div>
                    <div class="metric-label">Total Users</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="active-users">--</div>
                    <div class="metric-label">Active Users</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="total-samples">--</div>
                    <div class="metric-label">Total Samples</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="success-rate">--</div>
                    <div class="metric-label">Success Rate</div>
                </div>
            </div>

            <!-- System Status -->
            <div class="card">
                <div class="card-header">
                    <h3>System Status</h3>
                    <button id="refresh-overview" class="btn btn-small btn-primary">Refresh</button>
                </div>
                <div class="card-body">
                    <div id="system-status">Loading system status...</div>
                </div>
            </div>

            <!-- System-wide Charts -->
            <div class="chart-container">
                <div id="system-chart"></div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h3>Recent Activity</h3>
                </div>
                <div class="card-body">
                    <div id="recent-activity">Loading recent activity...</div>
                </div>
            </div>
        </div>

        <!-- User Analytics Tab -->
        <div id="analytics-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>User Selection</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="analytics-user-select">Select User:</label>
                        <select id="analytics-user-select" class="form-control">
                            <option value="">Loading users...</option>
                        </select>
                    </div>
                    <button id="load-analytics" class="btn btn-primary">Load Analytics</button>
                </div>
            </div>

            <!-- User Stats -->
            <div class="card">
                <div class="card-header">
                    <h3>User Statistics</h3>
                </div>
                <div class="card-body">
                    <div id="user-stats">Select a user to view statistics</div>
                </div>
            </div>

            <!-- User Charts -->
            <div class="row">
                <div class="col">
                    <div class="chart-container">
                        <div id="score-timeline-chart"></div>
                    </div>
                </div>
                <div class="col">
                    <div class="chart-container">
                        <div id="risk-distribution-chart"></div>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div id="verdict-pie-chart"></div>
            </div>
        </div>

        <!-- Security Monitor Tab -->
        <div id="security-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>🔒 Security Monitoring</h3>
                    <button id="refresh-security" class="btn btn-small btn-danger">Refresh</button>
                </div>
                <div class="card-body">
                    <!-- Risk Alerts -->
                    <div id="security-alerts" class="alert-container">
                        Loading security status...
                    </div>

                    <!-- High-Risk Users -->
                    <h4>High-Risk Users</h4>
                    <div id="high-risk-users">
                        <div class="spinner"></div>
                    </div>

                    <!-- Recent Security Events -->
                    <h4>Recent Security Events</h4>
                    <div id="security-events">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Real-time Monitoring Controls -->
            <div class="card">
                <div class="card-header">
                    <h3>Real-time Monitoring</h3>
                </div>
                <div class="card-body">
                    <button id="start-monitoring" class="btn btn-success">Start Real-time Monitoring</button>
                    <button id="stop-monitoring" class="btn btn-danger" disabled>Stop Monitoring</button>
                    <div id="monitoring-status" style="margin-top: 10px;">
                        Monitoring is stopped
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Export Tab -->
        <div id="exports-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>📊 Data Export</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="export-type">Export Type:</label>
                        <select id="export-type" class="form-control">
                            <option value="samples">Biometric Samples</option>
                            <option value="scores">Authentication Scores</option>
                            <option value="users">User Data</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="export-user">User Filter (optional):</label>
                        <select id="export-user" class="form-control">
                            <option value="">All Users</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="export-format">Format:</label>
                        <select id="export-format" class="form-control">
                            <option value="csv">CSV</option>
                            <option value="json">JSON</option>
                        </select>
                    </div>

                    <button id="export-data" class="btn btn-primary">Export Data</button>
                    
                    <div id="export-status" style="margin-top: 15px;"></div>
                    <div id="export-download" style="margin-top: 10px;"></div>
                </div>
            </div>

            <!-- Export History -->
            <div class="card">
                <div class="card-header">
                    <h3>Export History</h3>
                </div>
                <div class="card-body">
                    <div id="export-history">
                        <p>No exports yet. Create your first export above.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div id="qr-modal" class="step-up-modal" style="display: none;">
            <div class="modal-content">
                <h3>📱 Mobile Access</h3>
                <p>Scan this QR code with your mobile device:</p>
                <div id="qr-code-container"></div>
                <button onclick="closeQRModal()" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Floating Action Button for QR Code -->
    <div class="floating-btn" onclick="showQRCode()">
        📱
    </div>

    <script>
        // Global state
        let currentTab = 'overview';
        let monitoringActive = false;
        let monitoringInterval = null;
        let users = [];

        // API base URL
        const API_BASE = 'http://localhost:8000';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            loadOverview();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.textContent.toLowerCase().replace(' ', '-');
                    showTab(tabName);
                });
            });

            // Overview
            document.getElementById('refresh-overview').addEventListener('click', loadOverview);

            // Analytics
            document.getElementById('load-analytics').addEventListener('click', loadUserAnalytics);

            // Security
            document.getElementById('refresh-security').addEventListener('click', loadSecurityStatus);
            document.getElementById('start-monitoring').addEventListener('click', startMonitoring);
            document.getElementById('stop-monitoring').addEventListener('click', stopMonitoring);

            // Export
            document.getElementById('export-data').addEventListener('click', exportData);
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            const tabId = tabName + '-tab';
            const tabElement = document.getElementById(tabId);
            if (tabElement) {
                tabElement.classList.add('active');
            }

            // Add active class to clicked button
            const activeBtn = Array.from(document.querySelectorAll('.tab-btn'))
                .find(btn => btn.textContent.toLowerCase().replace(' ', '-') === tabName);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            currentTab = tabName;

            // Load tab-specific data
            switch(tabName) {
                case 'overview':
                    loadOverview();
                    break;
                case 'analytics':
                    loadUsers();
                    break;
                case 'security':
                    loadSecurityStatus();
                    break;
                case 'exports':
                    loadUsers(); // For export user filter
                    break;
            }
        }

        // API Functions
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(API_BASE + endpoint, options);
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                return { error: error.message };
            }
        }

        // Load Users
        async function loadUsers() {
            const result = await apiRequest('/users');
            
            if (result.error) {
                console.error('Failed to load users:', result.error);
                return;
            }

            users = result.users || [];

            // Update user selectors
            const analyticsSelect = document.getElementById('analytics-user-select');
            const exportSelect = document.getElementById('export-user');

            // Clear and populate analytics selector
            analyticsSelect.innerHTML = '<option value="">Select a user...</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = `${user.user_id} (${user.email || 'No email'})`;
                analyticsSelect.appendChild(option);
            });

            // Clear and populate export selector
            exportSelect.innerHTML = '<option value="">All Users</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = user.user_id;
                exportSelect.appendChild(option);
            });
        }

        // Overview Functions
        async function loadOverview() {
            try {
                // Get system status
                const statusResult = await apiRequest('/status');
                const configResult = await apiRequest('/config');

                if (statusResult.error || configResult.error) {
                    throw new Error('Failed to load system data');
                }

                // Update metrics
                const userStats = statusResult.users || {};
                const totalUsers = Object.keys(userStats).length;
                const activeUsers = totalUsers; // Assuming all are active for now

                const totalSamples = Object.values(userStats).reduce((sum, stats) => 
                    sum + (stats.positives || 0) + (stats.impostors || 0), 0);

                document.getElementById('total-users').textContent = totalUsers;
                document.getElementById('active-users').textContent = activeUsers;
                document.getElementById('total-samples').textContent = totalSamples;
                document.getElementById('success-rate').textContent = '95%'; // Placeholder

                // Update system status
                const configStatus = configResult.config_status || {};
                let statusHtml = '<div class="metrics-grid">';

                Object.entries(configStatus).forEach(([service, status]) => {
                    const icon = status ? '✅' : '❌';
                    const statusClass = status ? 'success' : 'danger';
                    statusHtml += `
                        <div class="metric-card">
                            <div class="metric-value ${statusClass}">${icon}</div>
                            <div class="metric-label">${service.replace('_', ' ').toUpperCase()}</div>
                        </div>
                    `;
                });

                statusHtml += '</div>';
                document.getElementById('system-status').innerHTML = statusHtml;

                // Create system chart
                createSystemChart(userStats);

                // Update recent activity
                updateRecentActivity(userStats);

            } catch (error) {
                console.error('Error loading overview:', error);
                document.getElementById('system-status').innerHTML = 
                    '<div class="alert alert-danger">Error loading system status</div>';
            }
        }

        function createSystemChart(userStats) {
            const users = Object.keys(userStats);
            const positives = users.map(user => userStats[user].positives || 0);
            const negatives = users.map(user => userStats[user].impostors || 0);

            const trace1 = {
                x: users,
                y: positives,
                name: 'Positive Samples',
                type: 'bar',
                marker: { color: '#28a745' }
            };

            const trace2 = {
                x: users,
                y: negatives,
                name: 'Negative Samples',
                type: 'bar',
                marker: { color: '#dc3545' }
            };

            const layout = {
                title: 'Sample Distribution by User',
                xaxis: { title: 'Users' },
                yaxis: { title: 'Sample Count' },
                barmode: 'stack'
            };

            Plotly.newPlot('system-chart', [trace1, trace2], layout);
        }

        function updateRecentActivity(userStats) {
            let activityHtml = '<ul>';
            
            Object.entries(userStats).slice(0, 5).forEach(([userId, stats]) => {
                const total = (stats.positives || 0) + (stats.impostors || 0);
                activityHtml += `<li>${userId}: ${total} total samples (${stats.positives || 0} positive)</li>`;
            });

            if (Object.keys(userStats).length === 0) {
                activityHtml += '<li>No activity data available</li>';
            }

            activityHtml += '</ul>';
            document.getElementById('recent-activity').innerHTML = activityHtml;
        }

        // User Analytics Functions
        async function loadUserAnalytics() {
            const userId = document.getElementById('analytics-user-select').value;
            
            if (!userId) {
                alert('Please select a user first');
                return;
            }

            try {
                // Load user stats
                const statsResult = await apiRequest(`/users/${userId}/stats`);
                const metricsResult = await apiRequest(`/users/${userId}/metrics`);

                if (statsResult.error || metricsResult.error) {
                    throw new Error('Failed to load user data');
                }

                // Update user stats display
                updateUserStats(statsResult);

                // Create charts
                createUserCharts(metricsResult.metrics, userId);

            } catch (error) {
                console.error('Error loading user analytics:', error);
                document.getElementById('user-stats').innerHTML = 
                    '<div class="alert alert-danger">Error loading user analytics</div>';
            }
        }

        function updateUserStats(statsResult) {
            const stats = statsResult.sample_counts || {};
            const recentAuths = statsResult.recent_authentications || [];
            const modelStats = statsResult.model_stats || {};

            let statsHtml = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${stats.positive || 0}</div>
                        <div class="metric-label">Positive Samples</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${stats.negative || 0}</div>
                        <div class="metric-label">Negative Samples</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${recentAuths.length}</div>
                        <div class="metric-label">Recent Auths</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${modelStats.model_exists ? '✅' : '❌'}</div>
                        <div class="metric-label">Model Status</div>
                    </div>
                </div>
            `;

            if (recentAuths.length > 0) {
                statsHtml += '<h4>Recent Authentications:</h4><ul>';
                recentAuths.slice(0, 5).forEach(auth => {
                    const timestamp = new Date(auth.timestamp).toLocaleString();
                    statsHtml += `
                        <li>
                            ${timestamp} - 
                            <span class="status-${auth.verdict}">${auth.verdict}</span> 
                            (${(auth.confidence * 100).toFixed(1)}% confidence, 
                            <span class="risk-${auth.risk_level}">${auth.risk_level}</span> risk)
                        </li>
                    `;
                });
                statsHtml += '</ul>';
            }

            document.getElementById('user-stats').innerHTML = statsHtml;
        }

        function createUserCharts(metrics, userId) {
            if (!metrics || !metrics.timestamps) {
                // Clear charts if no data
                Plotly.purge('score-timeline-chart');
                Plotly.purge('risk-distribution-chart');
                Plotly.purge('verdict-pie-chart');
                return;
            }

            const timestamps = metrics.timestamps.map(ts => new Date(ts));
            const scores = metrics.scores;
            const verdicts = metrics.verdicts;
            const riskLevels = metrics.risk_levels;

            // Score Timeline Chart
            const timelineTrace = {
                x: timestamps,
                y: scores,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Authentication Score',
                line: { color: '#007bff', width: 2 },
                marker: { size: 6 }
            };

            const timelineLayout = {
                title: `Authentication Score Timeline - ${userId}`,
                xaxis: { title: 'Time' },
                yaxis: { title: 'Score', range: [0, 1] },
                shapes: [
                    {
                        type: 'line',
                        x0: timestamps[0],
                        x1: timestamps[timestamps.length - 1],
                        y0: 0.6,
                        y1: 0.6,
                        line: { color: 'green', width: 2, dash: 'dash' }
                    },
                    {
                        type: 'line',
                        x0: timestamps[0],
                        x1: timestamps[timestamps.length - 1],
                        y0: 0.3,
                        y1: 0.3,
                        line: { color: 'red', width: 2, dash: 'dash' }
                    }
                ]
            };

            Plotly.newPlot('score-timeline-chart', [timelineTrace], timelineLayout);

            // Risk Distribution Chart
            const riskCounts = {};
            riskLevels.forEach(risk => {
                riskCounts[risk] = (riskCounts[risk] || 0) + 1;
            });

            const riskTrace = {
                x: Object.keys(riskCounts),
                y: Object.values(riskCounts),
                type: 'bar',
                marker: {
                    color: Object.keys(riskCounts).map(risk => {
                        switch(risk) {
                            case 'low': return '#28a745';
                            case 'medium': return '#ffc107';
                            case 'high': return '#dc3545';
                            case 'critical': return '#6f42c1';
                            default: return '#6c757d';
                        }
                    })
                }
            };

            const riskLayout = {
                title: `Risk Level Distribution - ${userId}`,
                xaxis: { title: 'Risk Level' },
                yaxis: { title: 'Count' }
            };

            Plotly.newPlot('risk-distribution-chart', [riskTrace], riskLayout);

            // Verdict Pie Chart
            const verdictCounts = {};
            verdicts.forEach(verdict => {
                verdictCounts[verdict] = (verdictCounts[verdict] || 0) + 1;
            });

            const pieTrace = {
                labels: Object.keys(verdictCounts),
                values: Object.values(verdictCounts),
                type: 'pie',
                marker: {
                    colors: Object.keys(verdictCounts).map(verdict => {
                        switch(verdict) {
                            case 'genuine': return '#28a745';
                            case 'impostor': return '#dc3545';
                            case 'uncertain': return '#ffc107';
                            default: return '#6c757d';
                        }
                    })
                }
            };

            const pieLayout = {
                title: `Verdict Distribution - ${userId}`
            };

            Plotly.newPlot('verdict-pie-chart', [pieTrace], pieLayout);
        }

        // Security Functions
        async function loadSecurityStatus() {
            try {
                const statusResult = await apiRequest('/status');
                const usersResult = await apiRequest('/users');

                if (statusResult.error || usersResult.error) {
                    throw new Error('Failed to load security data');
                }

                // Check for high-risk users
                const users = usersResult.users || [];
                const highRiskUsers = users.filter(user => user.failed_attempts > 2);

                let alertsHtml = '';
                if (highRiskUsers.length > 0) {
                    alertsHtml += '<div class="alert alert-danger">';
                    alertsHtml += `<h4>⚠️ ${highRiskUsers.length} High-Risk User(s) Detected</h4>`;
                    alertsHtml += '<ul>';
                    highRiskUsers.forEach(user => {
                        alertsHtml += `<li>${user.user_id}: ${user.failed_attempts} failed attempts</li>`;
                    });
                    alertsHtml += '</ul></div>';
                } else {
                    alertsHtml += '<div class="alert alert-success">✅ No immediate security threats detected</div>';
                }

                document.getElementById('security-alerts').innerHTML = alertsHtml;

                // Update high-risk users list
                if (highRiskUsers.length > 0) {
                    let riskHtml = '<div class="table-responsive"><table class="table">';
                    riskHtml += '<thead><tr><th>User ID</th><th>Failed Attempts</th><th>Last Login</th><th>Actions</th></tr></thead><tbody>';
                    
                    highRiskUsers.forEach(user => {
                        riskHtml += `
                            <tr>
                                <td>${user.user_id}</td>
                                <td><span class="risk-high">${user.failed_attempts}</span></td>
                                <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                                <td>
                                    <button class="btn btn-small btn-warning" onclick="resetUserAttempts('${user.user_id}')">Reset</button>
                                    <button class="btn btn-small btn-danger" onclick="lockUser('${user.user_id}')">Lock</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    riskHtml += '</tbody></table></div>';
                    document.getElementById('high-risk-users').innerHTML = riskHtml;
                } else {
                    document.getElementById('high-risk-users').innerHTML = '<p>No high-risk users detected.</p>';
                }

                // Mock security events (in real app, this would come from the API)
                document.getElementById('security-events').innerHTML = `
                    <div class="alert alert-info">
                        <h5>Recent Security Events:</h5>
                        <ul>
                            <li>No recent security events</li>
                        </ul>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading security status:', error);
                document.getElementById('security-alerts').innerHTML = 
                    '<div class="alert alert-danger">Error loading security status</div>';
            }
        }

        function startMonitoring() {
            monitoringActive = true;
            document.getElementById('start-monitoring').disabled = true;
            document.getElementById('stop-monitoring').disabled = false;
            document.getElementById('monitoring-status').innerHTML = 
                '<div class="alert alert-info">🔄 Real-time monitoring active</div>';

            // Start periodic refresh
            monitoringInterval = setInterval(() => {
                if (currentTab === 'security') {
                    loadSecurityStatus();
                }
            }, 10000); // Refresh every 10 seconds
        }

        function stopMonitoring() {
            monitoringActive = false;
            document.getElementById('start-monitoring').disabled = false;
            document.getElementById('stop-monitoring').disabled = true;
            document.getElementById('monitoring-status').innerHTML = 'Monitoring is stopped';

            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
        }

        // Export Functions
        async function exportData() {
            const exportType = document.getElementById('export-type').value;
            const userId = document.getElementById('export-user').value;
            const format = document.getElementById('export-format').value;

            try {
                document.getElementById('export-status').innerHTML = 
                    '<div class="alert alert-info">🔄 Exporting data...</div>';

                let endpoint = `/export/${exportType}`;
                let params = new URLSearchParams();
                
                if (userId) {
                    params.append('user_id', userId);
                }

                if (params.toString()) {
                    endpoint += '?' + params.toString();
                }

                const response = await fetch(API_BASE + endpoint);
                
                if (!response.ok) {
                    throw new Error('Export failed');
                }

                // Create download link
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const filename = `${exportType}_export_${new Date().toISOString().slice(0, 10)}.${format}`;
                
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = filename;
                downloadLink.textContent = `Download ${filename}`;
                downloadLink.className = 'btn btn-success';

                document.getElementById('export-status').innerHTML = 
                    '<div class="alert alert-success">✅ Export completed successfully!</div>';
                
                document.getElementById('export-download').innerHTML = '';
                document.getElementById('export-download').appendChild(downloadLink);

                // Add to export history
                addToExportHistory(exportType, userId, filename);

            } catch (error) {
                console.error('Export error:', error);
                document.getElementById('export-status').innerHTML = 
                    '<div class="alert alert-danger">❌ Export failed: ' + error.message + '</div>';
            }
        }

        function addToExportHistory(type, userId, filename) {
            const historyContainer = document.getElementById('export-history');
            const timestamp = new Date().toLocaleString();
            
            const historyItem = document.createElement('div');
            historyItem.className = 'export-history-item';
            historyItem.innerHTML = `
                <div class="card" style="margin-bottom: 10px;">
                    <div class="card-body">
                        <strong>${filename}</strong><br>
                        Type: ${type} | User: ${userId || 'All'} | Created: ${timestamp}
                    </div>
                </div>
            `;
            
            if (historyContainer.children.length === 1 && 
                historyContainer.children[0].textContent.includes('No exports yet')) {
                historyContainer.innerHTML = '';
            }
            
            historyContainer.insertBefore(historyItem, historyContainer.firstChild);
        }

        // QR Code Functions
        async function showQRCode() {
            try {
                const result = await apiRequest('/qr-code');
                
                if (result.error) {
                    throw new Error(result.error);
                }

                document.getElementById('qr-code-container').innerHTML = `
                    <img src="${result.qr_code}" alt="QR Code" class="qr-code">
                    <p><strong>URL:</strong> ${result.url}</p>
                    <p>Scan this code to access the authentication interface on your mobile device.</p>
                `;

                document.getElementById('qr-modal').style.display = 'flex';

            } catch (error) {
                alert('Failed to generate QR code: ' + error.message);
            }
        }

        function closeQRModal() {
            document.getElementById('qr-modal').style.display = 'none';
        }

        // User Management Functions (called from security tab)
        async function resetUserAttempts(userId) {
            if (confirm(`Reset failed attempts for user: ${userId}?`)) {
                // In real implementation, this would call an API endpoint
                alert(`Failed attempts reset for ${userId} (not implemented)`);
            }
        }

        async function lockUser(userId) {
            if (confirm(`Lock user account: ${userId}?`)) {
                // In real implementation, this would call an API endpoint
                alert(`User ${userId} locked (not implemented)`);
            }
        }
    </script>

    <style>
        .tab-navigation {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 16px;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .tab-btn:hover {
            color: #007bff;
            background-color: #f8f9fa;
        }

        .tab-btn.active {
            color: #007bff;
            border-bottom-color: #007bff;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .floating-btn:hover {
            background: #0056b3;
            transform: scale(1.1);
        }

        .row {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .col {
            flex: 1;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .export-history-item {
            margin-bottom: 10px;
        }

        .alert-container {
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .tab-navigation {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                flex: 1;
                min-width: 120px;
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .row {
                flex-direction: column;
            }
            
            .floating-btn {
                bottom: 15px;
                right: 15px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</body>
</html>
